// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url is coming from prisma.config.ts in Prisma 7
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]

  // v1 nouns
  sources        Source[]
  requirements   Requirement[]
  projects       Project[]
  tasks          Task[]
  pages          Page[]
  evidence       Evidence[]
  edges          Edge[]
  tags           Tag[]
  tagAssignments TagAssignment[]

  @@index([createdAt])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships Membership[]

  // v1 nouns
  ownedRequirements Requirement[] @relation("RequirementOwner")
  assignedTasks     Task[]        @relation("TaskAssignee")

  @@index([createdAt])
}

model Membership {
  id          String         @id @default(cuid())
  workspaceId String
  userId      String
  role        MembershipRole @default(OWNER)
  createdAt   DateTime       @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

enum SourceType {
  URL
  PDF
}

model Source {
  id          String     @id @default(cuid())
  workspaceId String
  title       String
  type        SourceType @default(URL)
  url         String?
  filePath    String? // local path or storage key (v1 placeholder)
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([createdAt])
}

enum RequirementStatus {
  DRAFT
  ACTIVE
  BLOCKED
  DONE
}

enum RequirementPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model Requirement {
  id          String              @id @default(cuid())
  workspaceId String
  title       String
  body        String?
  status      RequirementStatus   @default(DRAFT)
  priority    RequirementPriority @default(MEDIUM)
  ownerId     String?
  dueDate     DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  owner     User?     @relation("RequirementOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([status])
  @@index([priority])
  @@index([ownerId])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  BLOCKED
  DONE
}

model Project {
  id          String   @id @default(cuid())
  workspaceId String
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@index([workspaceId])
  @@index([createdAt])
}

model Task {
  id          String     @id @default(cuid())
  workspaceId String
  title       String
  body        String?
  status      TaskStatus @default(TODO)
  assigneeId  String?
  dueDate     DateTime?
  projectId   String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignee  User?     @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)

  project Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([status])
  @@index([assigneeId])
  @@index([projectId])
}

model Page {
  id          String   @id @default(cuid())
  workspaceId String
  title       String
  body        String // markdown
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([createdAt])
}

enum EvidenceType {
  LINK
  FILE
}

model Evidence {
  id          String       @id @default(cuid())
  workspaceId String
  title       String
  type        EvidenceType @default(LINK)
  url         String?
  filePath    String?
  notes       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([type])
  @@index([createdAt])
}

enum EntityType {
  SOURCE
  REQUIREMENT
  TASK
  PROJECT
  PAGE
  EVIDENCE
}

enum EdgeType {
  DERIVED_FROM
  IMPLEMENTS
  DOCUMENTS
  EVIDENCE_FOR
  PART_OF
  RELATED_TO
}

model Edge {
  id          String @id @default(cuid())
  workspaceId String

  type     EdgeType
  fromType EntityType
  fromId   String
  toType   EntityType
  toId     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, type, fromType, fromId, toType, toId])
  @@index([workspaceId, type])
  @@index([workspaceId, fromType, fromId])
  @@index([workspaceId, toType, toId])
}

model Tag {
  id          String  @id @default(cuid())
  workspaceId String
  name        String
  color       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignments TagAssignment[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
}

model TagAssignment {
  id          String @id @default(cuid())
  workspaceId String

  tagId      String
  entityType EntityType
  entityId   String

  createdAt DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tag       Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, tagId, entityType, entityId])
  @@index([workspaceId, entityType, entityId])
  @@index([workspaceId, tagId])
}
